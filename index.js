const multer = require('multer');
const upload = multer({ dest: 'uploads/' });

const express = require('express');
const { Client, LocalAuth, MessageMedia } = require('whatsapp-web.js');
const qrcode = require('qrcode');
const path = require('path');
const fs = require('fs');
const axios = require('axios');
const mime = require('mime-types');
const cron = require('node-cron');
const swaggerUi = require('swagger-ui-express');
const YAML = require('yamljs');
const swaggerDocument = YAML.load('./swagger.yaml');

const app = express();
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

const session = require('express-session');

const ADMIN_PASSWORD = "admin123";   // ‚úÖ Change this to a strong password
const API_KEY = "123456"; // ‚úÖ Change this too

// ‚úÖ Session for dashboard login
app.use(session({
    secret: "whatsapp-dashboard-secret",
    resave: false,
    saveUninitialized: true
}));

// ‚úÖ Middleware for dashboard login
function requireLogin(req, res, next) {
    if (req.session.loggedIn) {
        next();
    } else {
        res.redirect('/login');
    }
}

// ‚úÖ Middleware for API auth
function requireApiKey(req, res, next) {
    const key = req.headers['x-api-key'];
    if (key === API_KEY) {
        next();
    } else {
        res.status(401).json({ error: 'Unauthorized - Invalid API Key' });
    }
}





// ‚úÖ Setup view engine and static files
app.set('view engine', 'ejs');
app.set('views', path.join(__dirname, 'views'));
app.use(express.static(path.join(__dirname, 'public')));

const clients = {};   // Store all active WhatsApp sessions
const qrCodes = {};   // Store QR codes for dashboard
const scheduledJobs = {}; // Store scheduled jobs for each session

// ‚úÖ Helper function to create or return a session
function createSession(sessionId) {
    if (clients[sessionId]) return clients[sessionId];

    const client = new Client({
        authStrategy: new LocalAuth({ clientId: sessionId }),
        puppeteer: { headless: true, args: ['--no-sandbox', '--disable-setuid-sandbox'] }
    });

    client.on('qr', async (qr) => {
        qrCodes[sessionId] = await qrcode.toDataURL(qr);
        console.log(`üì≤ QR generated for session: ${sessionId}`);
    });

    client.on('ready', () => {
        console.log(`‚úÖ Session ${sessionId} is ready!`);
        qrCodes[sessionId] = null; // QR disappears after login
    });

    client.on('disconnected', () => {
        console.log(`‚ùå Session ${sessionId} disconnected!`);
        delete clients[sessionId];
        qrCodes[sessionId] = null;
        fs.rmSync(path.join(__dirname, `.wwebjs_auth/session-${sessionId}`), { recursive: true, force: true });
    });

    // ‚úÖ Listen for incoming messages (webhook support)
    client.on('message', msg => {
        console.log(`üì© Message from ${msg.from}: ${msg.body}`);
        // üëâ You could send this to your webhook endpoint here
    });

    client.initialize();
    clients[sessionId] = client;
    return client;
}

////////////////////  Login/////////////////////////
// ‚úÖ Login Page
app.get('/login', (req, res) => {
    res.render('login', { error: null });
});


// ‚úÖ Login POST
app.post('/login', (req, res) => {
    const { password } = req.body;
    if (password === ADMIN_PASSWORD) {
        req.session.loggedIn = true;
        res.redirect('/');
    } else {
        res.render('login', { error: '‚ùå Wrong password. Try again.' });
    }
});


// ‚úÖ Logout
app.get('/logout', (req, res) => {
    req.session.destroy();
    res.redirect('/login');
});



//////////////////////////
// üìå DASHBOARD ROUTES //
//////////////////////////

// ‚úÖ Dashboard UI
app.get('/', requireLogin, (req, res) => {
    res.render('index', { 
        sessions: Object.keys(clients), 
        qrCodes,
        API_KEY   // ‚úÖ Pass API_KEY to EJS template
    });
});


// ‚úÖ Create New Session
app.post('/create-session', requireLogin, (req, res) => {
    const { sessionId } = req.body;
    if (!sessionId) return res.redirect('/');
    if (!clients[sessionId]) {
        createSession(sessionId);
    }
    res.redirect('/');
});

// ‚úÖ Logout Session
app.post('/logout-session', requireLogin, async (req, res) => {
    const { sessionId } = req.body;
    if (!sessionId) return res.redirect('/');

    const client = clients[sessionId];
    if (client) {
        try {
            await client.logout();  // ‚úÖ fixed typo here
            delete clients[sessionId];
            fs.rmSync(path.join(__dirname, `.wwebjs_auth/session-${sessionId}`), { recursive: true, force: true });
        } catch (err) {
            console.error(`‚ùå Error logging out session ${sessionId}:`, err);
        }
    }
    res.redirect('/');
});


//////////////////////
// üìå API ROUTES //
//////////////////////

// ‚úÖ Get QR Code for session
app.get('/get-qr/:sessionId', async (req, res) => {
    const sessionId = req.params.sessionId;
    if (!clients[sessionId]) createSession(sessionId);
    res.json({ sessionId, qr: qrCodes[sessionId] || '‚úÖ Already logged in' });
});

// ‚úÖ List active sessions
app.get('/sessions', (req, res) => {
    res.json({ activeSessions: Object.keys(clients) });
});

// ‚úÖ Send text to a number
app.post('/send-text', async (req, res) => {
    const { sessionId, number, message } = req.body;
    if (!sessionId || !number || !message) return res.status(400).json({ error: "Missing parameters" });

    const client = clients[sessionId] || createSession(sessionId);
    try {
        const whatsappId = number.includes('@c.us') ? number : `${number}@c.us`;
        await client.sendMessage(whatsappId, message);
        res.json({ status: 'success', message: 'Text sent' });
    } catch (err) {
        res.status(500).json({ error: err.toString() });
    }
});

// ‚úÖ Send text to a group

app.post('/send-text-group', async (req, res) => {
    const { sessionId, groupName, message } = req.body;
    if (!sessionId || !groupName || !message) return res.status(400).json({ error: "Missing parameters" });

    const client = clients[sessionId] || createSession(sessionId);
    try {
        const chats = await client.getChats();
        const group = chats.find(chat => chat.isGroup && chat.name === groupName);
        if (!group) return res.status(404).json({ error: "Group not found" });

        await client.sendMessage(group.id._serialized, message);
        res.json({ status: 'success', message: 'Text sent to group' });
    } catch (err) {
        res.status(500).json({ error: err.toString() });
    }
});

// ‚úÖ Send media to a number
app.post('/send-media', upload.single('file'), async (req, res) => {
    const { sessionId, number, caption } = req.body;
    if (!req.file) return res.status(400).send("No file uploaded");

    const client = clients[sessionId] || createSession(sessionId);

    try {
        const filePath = path.join(__dirname, req.file.path);
        const mimeType = mime.lookup(filePath);
        const fileData = fs.readFileSync(filePath, { encoding: 'base64' });

        const media = new MessageMedia(mimeType, fileData, req.file.originalname);
        const whatsappId = number.includes('@c.us') ? number : `${number}@c.us`;

        await client.sendMessage(whatsappId, media, { caption: caption || '' });
        fs.unlinkSync(filePath); // delete after sending
        res.send({ status: 'success', message: 'Media sent!' });
    } catch (err) {
        res.status(500).send({ error: err.toString() });
    }
});


// ‚úÖ Send media to a group
app.post('/send-media-group', upload.single('file'), async (req, res) => {
    const { sessionId, groupName, caption } = req.body;
    if (!req.file) return res.status(400).send("No file uploaded");
    if (!sessionId || !groupName) return res.status(400).send("Missing parameters");

    const client = clients[sessionId] || createSession(sessionId);

    try {
        const filePath = path.join(__dirname, req.file.path);
        const mimeType = mime.lookup(filePath);
        const fileData = fs.readFileSync(filePath, { encoding: 'base64' });

        const media = new MessageMedia(mimeType, fileData, req.file.originalname);

        const chats = await client.getChats();
        const group = chats.find(chat => chat.isGroup && chat.name === groupName);
        if (!group) {
            fs.unlinkSync(filePath);
            return res.status(404).send("Group not found");
        }

        await client.sendMessage(group.id._serialized, media, { caption: caption || '' });

        fs.unlinkSync(filePath); // cleanup
        res.send({ status: 'success', message: `Media sent to group ${groupName}` });
    } catch (err) {
        console.error(err);
        res.status(500).send(err.toString());
    }
});


// ‚úÖ Create a new group
app.post('/create-group', async (req, res) => {
    const { sessionId, groupName, participants } = req.body;
    if (!sessionId || !groupName || !participants) {
        return res.status(400).json({ error: "Missing parameters" });
    }

    const client = clients[sessionId] || createSession(sessionId);

    try {
        // ‚úÖ Split numbers by comma and clean them up
        const participantArray = participants.split(',').map(num => `${num.trim()}@c.us`);

        console.log("üìû Creating empty group:", groupName);

        // ‚úÖ Step 1: Create empty group
        const group = await client.createGroup(groupName, []);
        console.log("‚úÖ Group created:", group);

        // ‚úÖ Step 2: Add members one by one (safe method)
        for (const member of participantArray) {
            try {
                console.log(`‚ûï Adding ${member}`);
                await group.addParticipants([member]);
                await new Promise(resolve => setTimeout(resolve, 2000)); // wait 2 sec to avoid rate-limit
            } catch (addErr) {
                console.error(`‚ö†Ô∏è Failed to add ${member}:`, addErr);
            }
        }

        res.json({ status: 'success', group, added: participantArray });
    } catch (err) {
        console.error("‚ùå Group creation failed:", err);
        res.status(500).json({ error: err.message || err.toString() });
    }
});


// ‚úÖ Add member to a group
app.post('/add-member', async (req, res) => {
    const { sessionId, groupName, number } = req.body;
    if (!sessionId || !groupName || !number) return res.status(400).json({ error: "Missing parameters" });

    const client = clients[sessionId] || createSession(sessionId);
    try {
        const chats = await client.getChats();
        const group = chats.find(chat => chat.isGroup && chat.name === groupName);
        if (!group) return res.status(404).json({ error: "Group not found" });

        await group.addParticipants([`${number}@c.us`]);
        res.json({ status: 'success', message: 'Member added' });
    } catch (err) {
        res.status(500).json({ error: err.toString() });
    }
});

// ‚úÖ Schedule a message
app.post('/schedule-message', async (req, res) => {
    const { sessionId, number, message, cronTime } = req.body;
    if (!sessionId || !number || !message || !cronTime) return res.status(400).json({ error: "Missing parameters" });

    const client = clients[sessionId] || createSession(sessionId);

    try {
        const job = cron.schedule(cronTime, async () => {
            const whatsappId = number.includes('@c.us') ? number : `${number}@c.us`;
            await client.sendMessage(whatsappId, message);
            console.log(`üìÜ Scheduled message sent via ${sessionId}`);
        });

        scheduledJobs[`${sessionId}-${number}`] = job;
        res.json({ status: 'success', message: 'Message scheduled' });
    } catch (err) {
        res.status(500).json({ error: err.toString() });
    }
});

////////////////////////   Swagger API with auth key 

// ‚úÖ Send text to a number
app.post('/api/send-text', requireApiKey, async (req, res) => {
    const { sessionId, number, message } = req.body;
    if (!sessionId || !number || !message) {
        return res.status(400).json({ error: "Missing parameters" });
    }

    // üîÑ Create session if missing
    const client = clients[sessionId] || createSession(sessionId);

    try {
        // ‚úÖ WAIT until client is ready
        if (!client.info) {
            console.log(`‚è≥ Waiting for session ${sessionId} to be ready...`);
            await new Promise((resolve, reject) => {
                const timeout = setTimeout(() => reject(new Error("‚ùå Client not ready in 30s")), 30000);

                client.once('ready', () => {
                    clearTimeout(timeout);
                    resolve();
                });
            });
        }

        // ‚úÖ Format number
        const whatsappId = number.includes('@c.us') ? number : `${number}@c.us`;

        // ‚úÖ Send message
        await client.sendMessage(whatsappId, message);

        res.json({ status: 'success', message: 'Text sent' });
    } catch (err) {
        console.error("‚ùå Error in /api/send-text:", err);
        res.status(500).json({ error: err.toString() });
    }
});

// ‚úÖ Send text to a group

app.post('/api/send-text-group', requireApiKey, async (req, res) => {
    const { sessionId, groupName, message } = req.body;
    if (!sessionId || !groupName || !message) return res.status(400).json({ error: "Missing parameters" });

    const client = clients[sessionId] || createSession(sessionId);
    try {
        const chats = await client.getChats();
        const group = chats.find(chat => chat.isGroup && chat.name === groupName);
        if (!group) return res.status(404).json({ error: "Group not found" });

        await client.sendMessage(group.id._serialized, message);
        res.json({ status: 'success', message: 'Text sent to group' });
    } catch (err) {
        res.status(500).json({ error: err.toString() });
    }
});

// ‚úÖ Send media to a number
app.post('/api/send-media', requireApiKey, upload.single('file'), async (req, res) => {
    const { sessionId, number, caption } = req.body;
    if (!req.file) return res.status(400).send("No file uploaded");

    const client = clients[sessionId] || createSession(sessionId);

    try {
        // ‚úÖ Wait for client to be ready before sending media
        if (!client.info) {
            console.log(`‚è≥ Waiting for session ${sessionId} to be ready before sending media...`);
            await new Promise((resolve, reject) => {
                const timeout = setTimeout(() => reject(new Error("‚ùå Client not ready in 30s")), 30000);

                client.once('ready', () => {
                    clearTimeout(timeout);
                    resolve();
                });
            });
        }

        // ‚úÖ Read uploaded file
        const filePath = path.join(__dirname, req.file.path);
        const mimeType = mime.lookup(filePath);
        const fileData = fs.readFileSync(filePath, { encoding: 'base64' });

        const media = new MessageMedia(mimeType, fileData, req.file.originalname);
        const whatsappId = number.includes('@c.us') ? number : `${number}@c.us`;

        // ‚úÖ Send media
        await client.sendMessage(whatsappId, media, { caption: caption || '' });

        fs.unlinkSync(filePath); // üóë delete after sending
        res.send({ status: 'success', message: '‚úÖ Media sent!' });

    } catch (err) {
        console.error("‚ùå Error sending media:", err);
        res.status(500).send({ error: err.toString() });
    }
});



// ‚úÖ Send media to a group
app.post('/api/send-media-group', requireApiKey, upload.single('file'), async (req, res) => {
    const { sessionId, groupName, caption } = req.body;
    if (!req.file) return res.status(400).send("No file uploaded");
    if (!sessionId || !groupName) return res.status(400).send("Missing parameters");

    const client = clients[sessionId] || createSession(sessionId);

    try {
        const filePath = path.join(__dirname, req.file.path);
        const mimeType = mime.lookup(filePath);
        const fileData = fs.readFileSync(filePath, { encoding: 'base64' });

        const media = new MessageMedia(mimeType, fileData, req.file.originalname);

        const chats = await client.getChats();
        const group = chats.find(chat => chat.isGroup && chat.name === groupName);
        if (!group) {
            fs.unlinkSync(filePath);
            return res.status(404).send("Group not found");
        }

        await client.sendMessage(group.id._serialized, media, { caption: caption || '' });

        fs.unlinkSync(filePath); // cleanup
        res.send({ status: 'success', message: `Media sent to group ${groupName}` });
    } catch (err) {
        console.error(err);
        res.status(500).send(err.toString());
    }
});


// ‚úÖ Create a new group
app.post('/api/create-group', requireApiKey, async (req, res) => {
    const { sessionId, groupName, participants } = req.body;
    if (!sessionId || !groupName || !participants) {
        return res.status(400).json({ error: "Missing parameters" });
    }

    const client = clients[sessionId] || createSession(sessionId);

    try {
        // ‚úÖ Split numbers by comma and clean them up
        const participantArray = participants.split(',').map(num => `${num.trim()}@c.us`);

        console.log("üìû Creating empty group:", groupName);

        // ‚úÖ Step 1: Create empty group
        const group = await client.createGroup(groupName, []);
        console.log("‚úÖ Group created:", group);

        // ‚úÖ Step 2: Add members one by one (safe method)
        for (const member of participantArray) {
            try {
                console.log(`‚ûï Adding ${member}`);
                await group.addParticipants([member]);
                await new Promise(resolve => setTimeout(resolve, 2000)); // wait 2 sec to avoid rate-limit
            } catch (addErr) {
                console.error(`‚ö†Ô∏è Failed to add ${member}:`, addErr);
            }
        }

        res.json({ status: 'success', group, added: participantArray });
    } catch (err) {
        console.error("‚ùå Group creation failed:", err);
        res.status(500).json({ error: err.message || err.toString() });
    }
});


// ‚úÖ Add member to a group
app.post('/api/add-member', requireApiKey, async (req, res) => {
    const { sessionId, groupName, number } = req.body;
    if (!sessionId || !groupName || !number) return res.status(400).json({ error: "Missing parameters" });

    const client = clients[sessionId] || createSession(sessionId);
    try {
        const chats = await client.getChats();
        const group = chats.find(chat => chat.isGroup && chat.name === groupName);
        if (!group) return res.status(404).json({ error: "Group not found" });

        await group.addParticipants([`${number}@c.us`]);
        res.json({ status: 'success', message: 'Member added' });
    } catch (err) {
        res.status(500).json({ error: err.toString() });
    }
});

// ‚úÖ Schedule a message
app.post('/api/schedule-message', requireApiKey, async (req, res) => {
    const { sessionId, number, message, cronTime } = req.body;
    if (!sessionId || !number || !message || !cronTime) return res.status(400).json({ error: "Missing parameters" });

    const client = clients[sessionId] || createSession(sessionId);

    try {
        const job = cron.schedule(cronTime, async () => {
            const whatsappId = number.includes('@c.us') ? number : `${number}@c.us`;
            await client.sendMessage(whatsappId, message);
            console.log(`üìÜ Scheduled message sent via ${sessionId}`);
        });

        scheduledJobs[`${sessionId}-${number}`] = job;
        res.json({ status: 'success', message: 'Message scheduled' });
    } catch (err) {
        res.status(500).json({ error: err.toString() });
    }
});


////////////////End Swager          




// ‚úÖ Get all groups
app.get('/groups/:sessionId', async (req, res) => {
    const { sessionId } = req.params;
    const client = clients[sessionId] || createSession(sessionId);
    try {
        const chats = await client.getChats();
        const groups = chats.filter(chat => chat.isGroup).map(chat => chat.name);
        res.json(groups);
    } catch (err) {
        res.status(500).json({ error: err.toString() });
    }
});

// ‚úÖ Get all contacts
app.get('/contacts/:sessionId', async (req, res) => {
    const { sessionId } = req.params;
    const client = clients[sessionId] || createSession(sessionId);
    try {
        const contacts = await client.getContacts();
        res.json(contacts.map(c => ({
            name: c.name || c.pushname || c.number,
            number: c.number
        })));
    } catch (err) {
        res.status(500).json({ error: err.toString() });
    }
});

app.get('/api/groups/:sessionId', async (req, res) => {
    const { sessionId } = req.params;
    const client = clients[sessionId] || createSession(sessionId);
    try {
        const chats = await client.getChats();
        const groups = chats.filter(chat => chat.isGroup).map(chat => chat.name);
        res.json(groups);
    } catch (err) {
        res.status(500).json({ error: err.toString() });
    }
});

app.get('/api/contacts/:sessionId', async (req, res) => {
    const { sessionId } = req.params;
    const client = clients[sessionId] || createSession(sessionId);
    try {
        const contacts = await client.getContacts();
        res.json(contacts.map(c => ({
            name: c.name || c.pushname || c.number,
            number: c.number
        })));
    } catch (err) {
        res.status(500).json({ error: err.toString() });
    }
});

app.get('/api-docs', (req, res) => {
    res.json({
        auth: "All API calls require header: x-api-key",
        api_key: API_KEY,
        endpoints: {
            "POST /send-text": { body: "{ sessionId, number, message }" },
            "POST /send-text-group": { body: "{ sessionId, groupName, message }" },
            "POST /send-media": { body: "{ sessionId, number, mediaUrl, caption }" },
            "POST /send-media-group": { body: "{ sessionId, groupName, mediaUrl, caption }" },
            "POST /create-group": { body: "{ sessionId, groupName, participants }" },
            "POST /add-member": { body: "{ sessionId, groupName, number }" },
            "GET /api/groups/:sessionId": "Returns all groups",
            "GET /api/contacts/:sessionId": "Returns all contacts"
        }
    });
});

app.use('/swagger', swaggerUi.serve, swaggerUi.setup(swaggerDocument));

//////////////////////////////////
// üöÄ START SERVER
//////////////////////////////////
app.listen(3001, () => console.log('üöÄ Full WhatsApp API + Dashboard running at http://localhost:3001'));
